generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  username               String                 @unique
  email                  String                 @unique
  password               String
  name                   String
  phone                  String?
  address                String?
  dateOfBirth            DateTime?
  placeOfBirth           String?
  nip                    String?                @unique
  employeeStatus         String                 @default("PKWT")
  joinDate               DateTime?
  roleId                 String
  divisionId             String
  accessLevel            Int                    @default(5)
  companyType            String                 @default("subsidiary")
  supervisorId           String?
  bpjsHealth             String?
  bpjsEmployment         String?
  overtimeRate           Decimal                @default(0) @db.Decimal(10, 2)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  contractEndDate        DateTime?
  contractStartDate      DateTime?
  gender                 String?                @default("Male")
  plottingCompany        String?                @default("PT Rhayakan Film Indonesia")
  lastPasswordChange     DateTime?
  adjustmentsMade        BalanceAdjustmentLog[] @relation("AdjustedBy")
  balanceAdjustments     BalanceAdjustmentLog[]
  leaveBalances          LeaveBalance[]
  leaveApprovals         LeaveRequest[]         @relation("LeaveCurrentApprover")
  divisionHeadLeaves     LeaveRequest[]         @relation("LeaveDivisionHead")
  leaveRequests          LeaveRequest[]
  supervisorLeaves       LeaveRequest[]         @relation("LeaveSupervisor")
  overtimeBalance        OvertimeBalance?
  overtimeRecaps         OvertimeRecap[]
  recapsMade             OvertimeRecap[]        @relation("RecappedBy")
  overtimeApprovals      OvertimeRequest[]      @relation("CurrentApprover")
  divisionHeadOvertimes  OvertimeRequest[]      @relation("OvertimeDivisionHead")
  overtimeRequests       OvertimeRequest[]
  finalApprovals         OvertimeRequest[]      @relation("FinalApprover")
  supervisorOvertimes    OvertimeRequest[]      @relation("OvertimeSupervisor")
  overtimeRevisions      OvertimeRevision[]
  PasswordReset          PasswordReset[]
  payslips               Payslip[]
  uploadedPayslips       Payslip[]              @relation("UploadedPayslips")
  recapDateAdjustments   RecapDateAdjustment[]  @relation("RecapDateAdjustedBy")
  systemSettingsRecapped SystemSettings[]       @relation("SystemSettingsRecappedBy")
  toilEntries            TimeOffInLieu[]
  division               Division               @relation(fields: [divisionId], references: [id])
  role                   Role                   @relation(fields: [roleId], references: [id])
  supervisor             User?                  @relation("Supervision", fields: [supervisorId], references: [id], onUpdate: NoAction)
  subordinates           User[]                 @relation("Supervision")

  @@index([email])
  @@index([username])
  @@index([supervisorId])
  @@index([roleId])
  @@index([divisionId])
  @@index([accessLevel])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  users       User[]
}

model Division {
  id          String   @id @default(cuid())
  name        String
  headId      String?
  createdAt   DateTime @default(now())
  description String?
  users       User[]

  @@map("Division")
}

model LeaveBalance {
  id                 String   @id @default(cuid())
  employeeId         String
  annualQuota        Int      @default(0)
  annualUsed         Int      @default(0)
  annualRemaining    Int      @default(0)
  sickLeaveUsed      Int      @default(0)
  menstrualLeaveUsed Int      @default(0)
  unpaidLeaveUsed    Int      @default(0)
  year               Int
  updatedAt          DateTime @updatedAt
  createdAt          DateTime @default(now())
  toilBalance        Int      @default(0)
  toilExpired        Int      @default(0)
  toilUsed           Int      @default(0)
  employee           User     @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, year])
  @@map("LeaveBalance")
}

model LeaveRequest {
  id                  String         @id @default(cuid())
  leaveType           String
  startDate           DateTime
  endDate             DateTime
  reason              String
  status              String         @default("PENDING")
  approvedAt          DateTime?
  rejectedAt          DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  attachment          String?
  currentApproverId   String?
  divisionHeadComment String?
  divisionHeadDate    DateTime?
  divisionHeadId      String?
  divisionHeadStatus  String?
  employeeId          String
  isPaid              Boolean        @default(true)
  supervisorComment   String?
  supervisorDate      DateTime?
  supervisorId        String?
  supervisorStatus    String?
  totalDays           Float
  isToil              Boolean        @default(false)
  currentApprover     User?          @relation("LeaveCurrentApprover", fields: [currentApproverId], references: [id])
  divisionHead        User?          @relation("LeaveDivisionHead", fields: [divisionHeadId], references: [id])
  employee            User           @relation(fields: [employeeId], references: [id])
  supervisor          User?          @relation("LeaveSupervisor", fields: [supervisorId], references: [id])
  toilEntry           TimeOffInLieu?

  @@map("LeaveRequest")
}

model OvertimeRequest {
  id                  String             @id @default(cuid())
  employeeId          String
  submittedAt         DateTime           @default(now())
  status              String             @default("PENDING")
  currentApproverId   String?
  supervisorId        String?
  supervisorStatus    String             @default("PENDING")
  supervisorComment   String?
  supervisorDate      DateTime?
  divisionHeadId      String?
  divisionHeadStatus  String             @default("PENDING")
  divisionHeadComment String?
  divisionHeadDate    DateTime?
  totalHours          Float
  totalAmount         Float
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  approvedAt          DateTime?
  rejectedAt          DateTime?
  finalApproverId     String?
  recapId             String?
  isRecapped          Boolean            @default(false)
  recappedDate        DateTime?
  entries             OvertimeEntry[]
  currentApprover     User?              @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  divisionHead        User?              @relation("OvertimeDivisionHead", fields: [divisionHeadId], references: [id])
  employee            User               @relation(fields: [employeeId], references: [id])
  finalApprover       User?              @relation("FinalApprover", fields: [finalApproverId], references: [id])
  recap               OvertimeRecap?     @relation(fields: [recapId], references: [id])
  supervisor          User?              @relation("OvertimeSupervisor", fields: [supervisorId], references: [id])
  revisions           OvertimeRevision[]

  @@index([employeeId])
  @@index([status])
  @@index([currentApproverId])
  @@index([isRecapped])
}

model OvertimeEntry {
  id                String          @id @default(cuid())
  overtimeRequestId String
  date              DateTime
  hours             Float
  description       String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  overtimeRequest   OvertimeRequest @relation(fields: [overtimeRequestId], references: [id], onDelete: Cascade)

  @@index([overtimeRequestId])
  @@index([date])
}

model OvertimeBalance {
  id              String    @id @default(cuid())
  employeeId      String    @unique
  currentBalance  Float     @default(0)
  pendingHours    Float     @default(0)
  totalPaid       Float     @default(0)
  lastProcessedAt DateTime?
  lastResetAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  employee        User      @relation(fields: [employeeId], references: [id])
}

model OvertimeRevision {
  id                String          @id @default(cuid())
  overtimeRequestId String
  revisedBy         String
  action            String
  changes           Json
  comment           String?
  createdAt         DateTime        @default(now())
  overtimeRequest   OvertimeRequest @relation(fields: [overtimeRequestId], references: [id], onDelete: Cascade)
  reviser           User            @relation(fields: [revisedBy], references: [id])

  @@index([overtimeRequestId])
}

model OvertimeRecap {
  id               String            @id @default(cuid())
  employeeId       String
  month            Int
  year             Int
  totalHours       Float
  paidHours        Float
  excessHours      Float
  carryoverHours   Float             @default(0)
  totalToilHours   Float
  toilDaysCreated  Int               @default(0)
  remainingHours   Float             @default(0)
  recappedById     String
  recappedAt       DateTime          @default(now())
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  fromDate         DateTime
  toDate           DateTime
  recapStatus      String            @default("success")
  failureReason    String?
  employee         User              @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  recappedBy       User              @relation("RecappedBy", fields: [recappedById], references: [id])
  overtimeRequests OvertimeRequest[]
  toilEntries      TimeOffInLieu[]

  @@unique([employeeId, year, month])
  @@index([employeeId])
  @@index([year, month])
  @@index([recapStatus])
  @@map("OvertimeRecap")
}

model TimeOffInLieu {
  id             String         @id @default(cuid())
  employeeId     String
  days           Int
  hoursSource    Float
  earnedMonth    Int
  earnedYear     Int
  expiryMonth    Int
  expiryYear     Int
  status         String         @default("available")
  usedDate       DateTime?
  expiredDate    DateTime?
  recapId        String?
  leaveRequestId String?        @unique
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  employee       User           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveRequest   LeaveRequest?  @relation(fields: [leaveRequestId], references: [id])
  recap          OvertimeRecap? @relation(fields: [recapId], references: [id])

  @@index([employeeId])
  @@index([status])
  @@index([earnedYear, earnedMonth])
  @@index([expiryYear, expiryMonth])
  @@map("TimeOffInLieu")
}

model Payslip {
  id           String    @id @default(cuid())
  grossSalary  Float?
  netSalary    Float?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  employeeId   String
  fileName     String
  fileSize     Int
  fileUrl      String
  month        Int
  uploadedAt   DateTime  @default(now())
  uploadedById String
  viewCount    Int       @default(0)
  viewedAt     DateTime?
  year         Int
  employee     User      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  uploadedBy   User      @relation("UploadedPayslips", fields: [uploadedById], references: [id])

  @@unique([employeeId, year, month])
  @@index([employeeId])
  @@index([year, month])
  @@map("Payslip")
}

model PasswordResetToken {
  id               String    @id @default(cuid())
  userId           String
  token            String    @unique
  tempPasswordHash String
  expiresAt        DateTime
  usedAt           DateTime?
  createdAt        DateTime  @default(now())

  @@index([token])
  @@index([expiresAt])
}

model BalanceAdjustmentLog {
  id              String   @id @default(cuid())
  userId          String
  adjustedBy      String
  type            String
  amount          Float
  previousBalance Float
  newBalance      Float
  reason          String
  year            Int?
  createdAt       DateTime @default(now())
  adjuster        User     @relation("AdjustedBy", fields: [adjustedBy], references: [id])
  user            User     @relation(fields: [userId], references: [id])

  @@map("BalanceAdjustmentLog")
}

model SystemSettings {
  id                   String    @id @default(cuid())
  lastRecapDate        DateTime?
  lastRecapMonth       Int?
  lastRecapYear        Int?
  isRecapInProgress    Boolean   @default(false)
  isApprovalLocked     Boolean   @default(false)
  lastRecapCompletedAt DateTime?
  lastRecapBy          String?
  updatedAt            DateTime  @updatedAt
  createdAt            DateTime  @default(now())
  lastRecapByUser      User?     @relation("SystemSettingsRecappedBy", fields: [lastRecapBy], references: [id])

  @@map("SystemSettings")
}

model RecapDateAdjustment {
  id         String   @id @default(cuid())
  oldDate    DateTime
  newDate    DateTime
  reason     String
  adjustedBy String
  createdAt  DateTime @default(now())
  adjuster   User     @relation("RecapDateAdjustedBy", fields: [adjustedBy], references: [id])

  @@index([createdAt(sort: Desc)])
  @@map("RecapDateAdjustment")
}

model PasswordReset {
  id        String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId    String
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  ipAddress String?
  createdAt DateTime  @default(now())
  users     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}
